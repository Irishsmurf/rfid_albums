# Vinyl Scrobbler for Last.fm

## Overview

The Vinyl Scrobbler project allows you to connect a physical action – scanning an RFID tag on a vinyl record sleeve – with your digital music listening history on Last.fm. By waving your tagged record near an RFID reader, the entire album is automatically scrobbled to your Last.fm account.

This system comprises two main components:
1.  A Python script (`rfid_reader.py`) that runs on a computer (like a Raspberry Pi) connected to a USB RFID reader. This script is now responsible for handling RFID scans, looking up album details, fetching tracklists from Last.fm, and directly scrobbling to Last.fm.
2.  A web application (`index.html`) used for initial setup, configuration (Firebase, Last.fm API keys, Discogs token), mapping RFID tags to albums, and viewing event logs from both the script and UI actions.

## Features

- **RFID Tag Scanning:** Detects RFID tags using a USB reader connected to the Python script.
- **Direct Last.fm Scrobbling:** The Python script directly scrobbles entire albums (all tracks) to your Last.fm account.
- **Web Interface (`index.html`):** A user-friendly web application for:
    - Firebase project configuration.
    - Securely entering and saving Last.fm API credentials (API Key, API Secret, Username) and authorizing the application with Last.fm to obtain a session key.
    - Configuring a Discogs Personal Access Token (optional, for barcode scanning functionality).
    - Mapping RFID tag IDs to specific albums (Artist and Album Title).
    - Viewing a collection of your mapped albums.
    - Barcode scanning (via device camera) to fetch album details from Discogs and pre-fill artist/album fields.
    - Viewing an "Event Log" which displays messages from UI operations and real-time logs from the `rfid_reader.py` script.
- **Firebase Backend:** Uses Firestore to:
    - Store Last.fm API settings, session keys, and Discogs tokens for the target user.
    - Store the user's album collection (RFID tag to album mappings).
    - Store logs generated by the `rfid_reader.py` script for display in the WebUI.
- **Anonymous Authentication:** Simple user identification in Firebase for storing personalized settings.
- **Dynamic Tracklist Fetching:** The Python script retrieves album tracklists from Last.fm before scrobbling.

## How It Works (New Architecture)

The project's workflow has been updated to make the Python script the primary actor for scrobbling:

1.  **Initial WebUI Setup:**
    *   The user configures their Firebase project details in `index.html`.
    *   The user enters their Last.fm API Key and Secret in `index.html` and saves them.
    *   The user authenticates with Last.fm via `index.html`, which stores the obtained session key in Firestore.
    *   Optionally, the user configures their Discogs token in `index.html` for barcode scanning.
2.  **Album Collection Management (WebUI):**
    *   The user adds albums to their collection via `index.html`, creating mappings between RFID tag IDs and album/artist information. This information is stored in Firestore.
3.  **Python Script Configuration (`rfid_reader.py`):**
    *   The user configures `rfid_reader.py` with:
        *   The path to their Firebase Admin SDK key (`serviceAccountKey.json`).
        *   Their Firebase `APP_ID` (Project ID).
        *   The `TARGET_USER_ID` (obtained from the WebUI footer after Firebase initialization) to specify which user's Last.fm configuration (API keys, session key) the script should use from Firestore.
        *   The `SERIAL_PORT` for the RFID reader.
4.  **Python Script Operation:**
    *   `rfid_reader.py` starts, connects to Firebase, and initializes the RFID reader.
    *   It fetches the Last.fm API key, secret, and session key for the `TARGET_USER_ID` from Firestore.
5.  **RFID Tag Scan & Scrobbling:**
    *   When an RFID tag is scanned:
        *   The Python script reads the `tag_id`.
        *   It looks up the `tag_id` in the Firestore 'albums' collection (created via the WebUI) to get the artist and album.
        *   If found, it calls the Last.fm API (`album.getinfo`) to fetch the tracklist for that album.
        *   It then calls the Last.fm API (`track.scrobble`) to scrobble all tracks, using the fetched Last.fm credentials and session key.
6.  **Logging:**
    *   `rfid_reader.py` logs its activities (e.g., connections, scans, scrobble attempts, successes, errors) to a dedicated `script_logs` collection in Firestore.
    *   `index.html` listens to this `script_logs` collection and displays new log entries in the "Event Log" section, alongside UI-specific logs.

## Prerequisites

- **Hardware:**
    - A USB RFID reader (e.g., 125kHz EM4100).
    - RFID tags.
    - A computer for `rfid_reader.py` (e.g., Raspberry Pi).
- **Software & Accounts:**
    - Python 3.x (for `rfid_reader.py`).
    - `pip` (Python package installer).
    - Firebase Project (with Anonymous Authentication enabled and Firestore database created).
    - Last.fm Account & Last.fm API Key/Secret.
    - (Optional) Discogs Account & Personal Access Token for barcode scanning.
    - Serial Port Identifier for your RFID reader.

## Setup

### Web Application Setup (`index.html`)

1.  **Create Firebase Project & Get Config:**
    *   Create a Firebase project at [console.firebase.google.com](https://console.firebase.google.com/).
    *   Enable "Anonymous" sign-in method in Firebase Authentication.
    *   Create a Firestore database (e.g., in test mode to start).
    *   Get your Firebase web app configuration object (from Project settings > Your apps).
2.  **Configure `index.html`:**
    *   Open `index.html` in a browser.
    *   Paste your Firebase config object into the "Firebase Config (JSON)" text area.
    *   Click "Save & Initialize Firebase". Status should show "Initialized".
    *   Note the **User ID** displayed in the footer. This is your `TARGET_USER_ID` for the Python script.
3.  **Configure Last.fm API in WebUI:**
    *   Go to "1. Last.fm API Settings".
    *   Enter your Last.fm API Key, API Secret, and Username. Click "Save Settings".
    *   Click "Authenticate with Last.fm" and authorize the app. Status should show "Authenticated".
4.  **(Optional) Configure Discogs Token in WebUI:**
    *   Go to "1.B Discogs API Settings".
    *   Enter your Discogs Personal Access Token. Click "Save Discogs Token".

### Python RFID Reader Script Setup (`rfid_reader.py`)

1.  **Install Python Libraries:**
    ```bash
    pip install pyserial firebase-admin requests
    ```
    (`requests` is used by the Last.fm API helper functions).
2.  **Configure Firebase Admin SDK:**
    *   In Firebase project settings > Service accounts, generate a new private key.
    *   Rename the downloaded JSON file to `serviceAccountKey.json`.
    *   Place `serviceAccountKey.json` in the same directory as `rfid_reader.py`.
3.  **Configure Script Variables in `rfid_reader.py`:**
    *   Open `rfid_reader.py` and modify:
        *   **`APP_ID`**: Change `'default-scrobbler-app'` to your Firebase Project ID (must match the `projectId` in your `firebaseConfig` used in the WebUI).
        *   **`TARGET_USER_ID`**: Change `'YOUR_USER_ID_FROM_WEB_UI'` to the User ID obtained from the WebUI footer after Firebase initialization. This tells the script which user's Last.fm settings to use from Firestore.
        *   **`SERIAL_PORT`**: Set to your RFID reader's serial port (e.g., `/dev/ttyUSB0`, `COM3`).
        *   **`BAUD_RATE`**: Default is `9600`. Change only if your reader differs.

## Running the Project

1.  **Web Application (`index.html`):**
    *   Open `index.html` in a browser.
    *   Verify Firebase is initialized and Last.fm is authenticated.
    *   Use the "Album Collection" section to map your RFID tags to albums if you haven't already.
2.  **Python RFID Reader Script (`rfid_reader.py`):**
    *   Ensure `serviceAccountKey.json` is present and script variables (`APP_ID`, `TARGET_USER_ID`, `SERIAL_PORT`) are correctly set.
    *   Connect your RFID reader.
    *   Run from terminal: `python rfid_reader.py`
    *   Look for connection success messages for Firebase and the reader in the console.
    *   The script will also log its startup and connection attempts to Firestore, visible in the WebUI's "Event Log".

## Usage

1.  Ensure both `index.html` (in browser) and `rfid_reader.py` (in terminal) are running.
2.  **Map Albums:** If an RFID tag isn't mapped, scan it. The `rfid_reader.py` script will log an event (visible in WebUI) that the tag is unknown. Use the WebUI's "Album Collection" section to map this tag ID to an artist and album. You can use the "Scan Barcode" feature to help populate artist/album fields.
3.  **Scrobble a Record:**
    *   Scan an RFID tag that has been mapped in your Album Collection.
    *   **Observe the Python Script Console:** You'll see local debug messages.
    *   **Observe the WebUI "Event Log":**
        *   "Tag Scanned: [ID]"
        *   "Found album details: [Album] by [Artist] for tag '[ID]'."
        *   "Attempting to scrobble album: '[Album]' by '[Artist]' for tag '[ID]'."
        *   (If successful) "Successfully scrobbled [X] tracks for album '[Album]' by '[Artist]' (Tag: [ID]). Ignored: [Y]."
        *   (If failed) Error messages detailing the issue.
4.  **Check Last.fm:** Your Last.fm profile should show the scrobbled tracks.

## Troubleshooting

**Web Application (`index.html`):**
*   Similar to before, focusing on Firebase config and Last.fm API key/secret setup.
*   **Event Log Not Showing Script Logs:**
    *   Ensure `APP_ID` in `rfid_reader.py` matches `projectId` in WebUI's Firebase config.
    *   Check Firestore rules (though default with anonymous auth usually allows writes to user-specific paths and reads from public paths if structured correctly).
    *   Verify the `script_logs` path in `index.html`'s listener matches the path used in `rfid_reader.py`.

**Python RFID Reader Script (`rfid_reader.py`):**
*   **Firebase Initialization Errors:** Usually due to `serviceAccountKey.json` (missing, wrong name, wrong location, invalid content).
*   **Serial Port Errors:** Incorrect `SERIAL_PORT`, reader not connected, or permissions issues (e.g., Linux `dialout` group).
*   **"APP_ID or TARGET_USER_ID is not configured"**: Ensure these variables are correctly set in the script. `TARGET_USER_ID` comes from the WebUI footer.
*   **Last.fm Config Errors (logged by script):**
    *   "Last.fm config document not found..." or "Last.fm session document not found...": Indicates the target user hasn't saved API settings or authenticated via the WebUI.
    *   "Last.fm configuration is incomplete...": Necessary fields (apiKey, apiSecret, sessionKey, username) are missing from the Firestore documents.
*   **Scrobbling Failures (logged by script):**
    *   "Could not fetch tracklist...": Problem with `album.getinfo` API call (wrong artist/album, API issue).
    *   "No tracks found...": Last.fm has no tracks for that album.
    *   "Failed to scrobble tracks...": Problem with `track.scrobble` API call. The log details should include Last.fm's response.

## License

The license for this project is not specified. If you intend to share or distribute this project publicly, it's recommended to add a `LICENSE` file (e.g., MIT License).
